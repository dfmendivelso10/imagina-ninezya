---
import Plantilla from '../plantillas/Principal.astro';
import Mapa from '@/componentes/Mapa.astro';
import LineaTiempo from '@/componentes/LineaTiempo.astro';
import Menu from '@/componentes/Menu.astro';
import SelectorNivel from '@/componentes/SelectorNivel.astro';
import MenuAnios from '@/componentes/MenuAnios.astro';
---

<Plantilla titulo="Los 10 Yas!">
  <main>
    <Menu />

    <div id="visualizaciones" class="columna">
      <section id="superior">
        <div id="cabecera">
          <div id="indicadorSeleccionado">
            <h2 id="nombreYa"></h2>
            <h2 id="nombreIndicador"></h2>
          </div>

          <MenuAnios />

          <SelectorNivel />
        </div>
        <Mapa ancho={30} alto={45} />
      </section>

      <LineaTiempo alto={25} />
    </div>

    <div id="comparativo" class="columna"></div>

    <div id="informacion">
      <p class="nombre"></p>
    </div>
  </main>
</Plantilla>

<script>
  import MapaDetalle from '@/componentes/MapaDetalle';
  import { añoSeleccionado, lugaresSeleccionados, indicadorSeleccionado, yaSeleccionado } from '@/utilidades/cerebro';
  const comparativo = document.getElementById('comparativo');
  const nombreIndicador = document.getElementById('nombreIndicador');
  const nombreYa = document.getElementById('nombreYa');
  const cabecera = document.getElementById('cabecera');

  // Mostrar nombre del indicador seleccionado
  indicadorSeleccionado.subscribe(async () => {
    if (indicadorSeleccionado.value) {
      nombreYa.innerText = `${yaSeleccionado.value}`;
      nombreIndicador.innerText = `${indicadorSeleccionado.value}`;
      cabecera.style.display = 'flex';
    }
  });

  añoSeleccionado.subscribe(async () => {
    const existentes = comparativo.querySelectorAll<MapaDetalle>('enflujo-mapita');

    if (existentes && existentes.length) {
      existentes.forEach((mapita) => {
        mapita.pintarMapa();
      });
    }
  });

  window.addEventListener('resize', () => {
    const existentes = comparativo.querySelectorAll<MapaDetalle>('enflujo-mapita');
    if (existentes && existentes.length) {
      existentes.forEach((mapita) => {
        mapita.escalar();
      });
    }
  });

  lugaresSeleccionados.subscribe((lista) => {
    const existentes = comparativo.querySelectorAll<MapaDetalle>('enflujo-mapita');

    if (lista.length) {
      lista.forEach(({ nombre, codigo }) => {
        let existeLugarEnDOM = false;

        existentes.forEach((mapita) => {
          if (mapita.id === `${codigo}`) {
            existeLugarEnDOM = true;
          }

          // Borrar si no está en la lista
          if (!lista.find((lugar) => lugar.codigo === mapita.id)) {
            if (comparativo.contains(mapita)) {
              comparativo.removeChild(mapita);
            }
          }
        });

        if (!existeLugarEnDOM) {
          const mapita = document.createElement('enflujo-mapita') as MapaDetalle;
          mapita.className = 'mapita';
          mapita.id = `${codigo}`;
          mapita.dataset.departamento = nombre;
          mapita.agregarTitulo(nombre);

          mapita.crearMapa();
          mapita.escalar();
          mapita.pintarMapa();
          comparativo.appendChild(mapita);
        }
      });
    } else {
      comparativo.innerHTML = '';
    }
  });
</script>

<style lang="scss" is:global>
  #cabecera {
    display: none;
    flex-direction: column;
  }
  #indicadorSeleccionado {
    margin-right: 1em;
    color: var(--moradoProfundo);
    flex-direction: column;
    width: 14vw;
    font-size: 1em;
    min-width: 250px;
    width: 15vw;
    margin: 1em;

    #nombreYa {
      background-color: var(--moradoProfundo);
      color: white;
      padding: 0.3em;
      margin: 0;
      border: 1px solid var(--moradoProfundo);
    }

    #nombreIndicador {
      padding: 0.3em;
      margin: 0;
      border: 1px solid var(--moradoProfundo);
    }
  }

  #contenedorMapa {
    position: relative;
  }
  h1 {
    display: block;
  }

  h2 {
    font-size: 1em;
    width: 70%;
  }

  main {
    display: flex;

    .columna {
      flex-basis: 41%;
    }
  }

  #informacion {
    position: absolute;
    pointer-events: none;
    opacity: 0;
    max-width: 200px;
    padding: 0.5em;
    font-size: 0.8em;
    font-weight: bold;

    background-color: rgb(253, 253, 250);
    color: black;
    z-index: 9;
    transition: opacity 0.42s ease-out;
    transform: translate(-50%, -105%);

    &.visible {
      opacity: 1;
    }
  }

  #comparativo {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-evenly;
    align-content: flex-start;
  }

  .mapita {
    stroke: var(--moradoProfundo);
    stroke-opacity: 0.5;
  }

  .contenedorMapita {
    border: 2px solid;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
</style>
