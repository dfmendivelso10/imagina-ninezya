---
import Plantilla from '../plantillas/Principal.astro';
import Mapa from '@/componentes/Mapa.astro';
import LineaTiempo from '@/componentes/LineaTiempo.astro';
import Menu from '@/componentes/Menu.astro';
import SelectorNivel from '@/componentes/SelectorNivel.astro';
---

<Plantilla titulo="Los 10 Yas!">
  <main>
    <Menu />

    <div id="visualizaciones" class="columna">
      <SelectorNivel />
      <Mapa ancho={30} alto={45} />
      <LineaTiempo alto={25} />
    </div>

    <div id="comparativo" class="columna"></div>

    <div id="informacion">
      <p class="nombre"></p>
    </div>
  </main>
</Plantilla>

<script>
  import MapaDetalle from '@/componentes/MapaDetalle';
  import { añoSeleccionado, lugaresSeleccionados } from '@/utilidades/cerebro';
  const comparativo = document.getElementById('comparativo');

  añoSeleccionado.subscribe(async () => {
    const existentes = comparativo.querySelectorAll<MapaDetalle>('enflujo-mapita');

    if (existentes && existentes.length) {
      existentes.forEach((mapita) => {
        mapita.pintarMapa();
      });
    }
  });

  window.addEventListener('resize', () => {
    const existentes = comparativo.querySelectorAll<MapaDetalle>('enflujo-mapita');
    if (existentes && existentes.length) {
      existentes.forEach((mapita) => {
        mapita.escalar();
      });
    }
  });

  lugaresSeleccionados.subscribe((lista) => {
    const existentes = comparativo.querySelectorAll<MapaDetalle>('enflujo-mapita');

    if (lista.length) {
      lista.forEach(({ nombre, codigo }) => {
        let existeLugarEnDOM = false;

        existentes.forEach((mapita) => {
          if (mapita.id === `${codigo}`) {
            existeLugarEnDOM = true;
          }

          // Borrar si no está en la lista
          if (!lista.find((lugar) => lugar.codigo === mapita.id)) {
            if (comparativo.contains(mapita)) {
              comparativo.removeChild(mapita);
            }
          }
        });

        if (!existeLugarEnDOM) {
          const mapita = document.createElement('enflujo-mapita') as MapaDetalle;
          mapita.className = 'mapita';
          mapita.id = `${codigo}`;
          mapita.dataset.departamento = nombre;
          mapita.agregarTitulo(nombre);

          mapita.crearMapa();
          mapita.escalar();
          mapita.pintarMapa();
          comparativo.appendChild(mapita);
        }
      });
    } else {
      comparativo.innerHTML = '';
    }
  });
</script>

<style lang="scss" is:global>
  #contenedorMapa {
    position: relative;
  }
  h1 {
    display: block;
  }

  h2 {
    font-size: 1em;
    width: 70%;
  }

  main {
    display: flex;

    .columna {
      flex-basis: 41%;
    }
  }

  #informacion {
    position: absolute;
    pointer-events: none;
    opacity: 0;
    max-width: 200px;
    padding: 0.5em;
    font-size: 0.8em;
    font-weight: bold;

    background-color: rgb(253, 253, 250);
    color: black;
    z-index: 9;
    transition: opacity 0.42s ease-out;
    transform: translate(-50%, -105%);

    &.visible {
      opacity: 1;
    }
  }

  #comparativo {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-evenly;
    align-content: flex-start;
  }

  .mapita {
    stroke: var(--moradoProfundo);
    stroke-opacity: 0.5;
  }

  .contenedorMapita {
    border: 2px solid;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
</style>
